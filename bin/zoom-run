#!/usr/bin/perl
use strict;
use warnings;

my $defaultMeetingId = "362104616";

my $usage = "Usage:
  $0 [MEETING_ID]
    if zoom is running: kill it
    otherwise: run zoom with zoommtg:// URL to join meeting
";

sub run(@);

sub main(@){
  my $meetingId = $defaultMeetingId;
  if(@_ > 0 and $_[0] =~ /^(\d+)$/){
    $meetingId = $1;
    shift;
  }elsif(@_ > 0 and $_[0] =~ /^https?:\/\/zoom\.us.*\/(\d+)$/){
    $meetingId = $1;
    shift;
  }elsif(@_ > 0 and $_[0] =~ /^zoommtg:\/\/.*\/(\d+)$/){
    $meetingId = $1;
    shift;
  }

  if(@_ > 0){
    die $usage;
  }

  my $pgrep = `pgrep --exact zoom`;
  my @pids = $pgrep =~ /\d+/g;

  if(@pids == 0){
    my $url = "zoommtg://zoom.us/join?action=join&confno=$meetingId";
    print "$url\n";
    run "zoom '$url' &";
    run "pulse-vol mic mute";
    run "sleep 3";
    run "pulse-vol mic mute";
  }else{
    for my $pid(@pids){
      run "kill", "-9", $pid;
    }
  }
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
