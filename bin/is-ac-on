#!/usr/bin/perl
use strict;
use warnings;
use Time::HiRes qw(time);

my $kurtosisThreshold = 5;

my $usage = "Usage:
  $0 [OPTS]
    run `sbcam`, pass the image produced to `kurtosis`,
      and print 'yes' for kurtosis>10 (lit LEDs are sharp)
      and print 'no' otherwise

   OPTS
     -v | --verbose
       print the output of sbcam, the image file name, and the kurtosis of the image
";

sub main(@){
  my $verbose = shift if @_ > 0 and $_[0] =~ /^(-v|--verbose)$/;
  die $usage if @_ > 0;

  my $file = "/tmp/is-ac-on_" . int(time*1000) . ".jpg";
  if($verbose){
    system "sbcam $file";
  }else{
    system "sbcam $file >/dev/null 2>/dev/null";
  }
  if(not -f $file){
    die "ERROR: file \"$file\" not found\n";
  }
  my $k = `kurtosis $file`;
  chomp $k;
  if($k !~ /^-?\d+(\.\d+)?$/){
    die "ERROR\n";
  }
  if(defined $verbose){
    print "$file => kurtosis=$k\n";
  }
  if($k > $kurtosisThreshold){
    print "yes\n";
  }else{
    print "no\n";
  }
}

&main(@ARGV);
