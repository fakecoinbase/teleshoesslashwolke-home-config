#!/usr/bin/perl
use strict;
use warnings;

my $ROOM_KEY = "dailystandup";

my $SECRETS_FILE = "$ENV{HOME}/.secrets";
my $SECRETS_APP = "jitsi";
my @CONFIG_KEYS = ($ROOM_KEY);
my @REQUIRED_KEYS = ($ROOM_KEY);

sub main(@){
  my $secrets = readSecrets();
  exec "chromium", "https://meet.jit.si/$$secrets{$ROOM_KEY}#config.startWithVideoMuted=true";
}

sub readSecrets(){
  my @lines = `cat $SECRETS_FILE 2>/dev/null`;
  my $cfg = {};
  my $okConfigKeys = join "|", @CONFIG_KEYS;
  for my $line(@lines){
    if($line =~ /^$SECRETS_APP\.($okConfigKeys)\s*=\s*(.+)$/){
      $$cfg{$1} = $2;
    }
  }
  for my $key(sort @REQUIRED_KEYS){
    die "Missing config '$key' in $SECRETS_FILE\n" if not defined $$cfg{$key};
  }
  return $cfg;
}

&main(@ARGV);
