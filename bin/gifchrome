#!/usr/bin/perl
use strict;
use warnings;
use Cwd qw(abs_path);

sub getHtml($$$$@);

my $DEFAULT_AUTOSCROLL_DELAY_MILLIS = 1000;
my $DEFAULT_AUTOSCROLL_BY_PX = 800;
my $USE_SINGLE_COLUMN_BUTTON = 1;

my $tmpHtmlFile = "/tmp/gifchrome.html";

my $usage = "Usage:
  $0 -h|--help
    show this message

  $0 [OPTS] [GIF_FILE GIF_FILE ..]
    generate an HTML file with <img> tags for the indicated images
    \"src\" is \"file://<ABS_PATH>\", where ABS_PATH is the absolute filepath
    open it with `chromium --incognito`
    if no images are passed in, all *.gif and *.GIF images in the CWD are used

  OPTS:
    --dir=PREFIX
      make \"src\" in img tags \"file://<PREFIX>/<GIF_FILE>\"
      where GIF_FILE is the absolute or relative path given

    -n|--nobrowser
      dont launch chromium, print HTML to console

    -a|--autoscroll
      scroll page slowly when you click on an image, click again to toggle

    --autoscroll-delay=DELAY_MILLIS
      if --autoscroll is given, scroll page every <DELAY_MILLIS> millis
      (default is $DEFAULT_AUTOSCROLL_DELAY_MILLIS)

    --autoscroll-px=PX
      if --autoscroll is given, scroll page by <PX> px
      (default is $DEFAULT_AUTOSCROLL_BY_PX)

    --clickbox
      include a textbox at the bottom
      when an image is clicked, put the image's filename in it
";

sub main(@){
  my $prefixDir = undef;
  my $noBrowser = 0;
  my $autoScroll = 0;
  my $includeClickBox = 0;
  my $autoScrollDelayMillis = $DEFAULT_AUTOSCROLL_DELAY_MILLIS;
  my $autoScrollByPx = $DEFAULT_AUTOSCROLL_BY_PX;
  while(@_ > 0 and $_[0] =~ /^-/){
    my $arg = shift;
    if($arg =~ /^(-h|--help)$/){
      print $usage;
      exit 0;
    }elsif($arg =~ /^--dir=(.+)$/){
      $prefixDir = $1;
    }elsif($arg =~ /^(-n|--nobrowser)$/){
      $noBrowser = 1;
    }elsif($arg =~ /^(-a|--autoscroll)$/){
      $autoScroll = 1;
    }elsif($arg =~ /^--autoscroll-delay=(\d+)$/){
      $autoScrollDelayMillis = $1;
      die "invalid autoscroll delay: $1\n" if $1 <= 0;
    }elsif($arg =~ /^--autoscroll-px=(\d+)$/){
      $autoScrollByPx = $1;
      die "invalid autoscroll scroll-by px: $1\n" if $1 <= 0;
    }elsif($arg =~ /^(--clickbox)$/){
      $includeClickBox = 1;
    }else{
      die $usage;
    }
  }

  my @gifs = @_;
  @gifs = (glob("*.gif"), glob "*.GIF") if @gifs == 0;

  for my $gif(@gifs){
    die "$usage\nFile not found: $gif\n" if not -f $gif;
  }

  my @imgPaths;
  if(defined $prefixDir){
    $prefixDir =~ s/\/$//;
    @imgPaths = map {"$prefixDir/$_"} @gifs;
  }else{
    @imgPaths = map {abs_path($_)} @gifs;
  }

  my $html = getHtml $autoScroll, $autoScrollDelayMillis, $autoScrollByPx,
    $includeClickBox, @imgPaths;

  if($noBrowser){
    print $html;
  }else{
    open FH, "> $tmpHtmlFile";
    print FH $html;
    close FH;

    system "chromium", "--incognito", $tmpHtmlFile;
    system "rm", $tmpHtmlFile;
  }
}

sub getHtml($$$$@){
  my ($autoScroll, $autoScrollDelayMillis, $autoScrollByPx,
   $includeClickBox, @imgAbsPaths) = @_;

  my $html = '';
  $html .= "<html>";
  $html .= "<head>";
  $html .= "
    <style>
      .container-single-column>* {
        display:block;
      }
    </style>
    <script>
    var scrollEnabled = false;
    var singleColEnabled = false;
    function addText(event) {
      var targ = event.target || event.srcElement;
      document.getElementById(\"clicked\").value += targ.src + \"\\n\";
    }
    function toggleSingleColumn(){
      singleColEnabled = !singleColEnabled;
      c = document.getElementById('container');
      if(singleColEnabled){
        c.classList.add('container-single-column');
      }else{
        c.classList.remove('container-single-column');
      }
    }
    function toggleScroll(){
      scrollEnabled = !scrollEnabled;
      if(scrollEnabled){
        pageScroll();
      }
    }
    function pageScroll() {
      if(scrollEnabled){
        window.scrollBy({
          behavior: 'smooth',
          top: $autoScrollByPx
        });
        scrolldelay = setTimeout('pageScroll()',$autoScrollDelayMillis);
      }else{
        window.scrollBy({
          behavior: 'instant',
          top: 0
        });
      }
    }
    </script>
  ";
  my $onclick = "";
  $onclick .= "addText(event); " if $includeClickBox;
  $onclick .= "toggleScroll(); " if $autoScroll;
  $html .= "<body>";
  $html .= ""
           . "<button"
           . " onclick='toggleSingleColumn()'"
           . " style='height: 100px; width:100%'"
           . ">"
           . "SINGLE COL"
           . "</button>\n" if $USE_SINGLE_COLUMN_BUTTON;
  $html .= "<div id='container'>";
  for my $img(@imgAbsPaths){
    my $fileUrl = "file://$img";
    $html .= "<img src=\"$fileUrl\" onclick=\"$onclick\"/>\n";
  }
  if($includeClickBox){
    $html .= "<textarea id=\"clicked\" rows=\"5\" cols=\"80\"></textarea>\n";
  }
  $html .= "</body>";
  $html .= "</head>";
  return $html;
}

&main(@ARGV);
